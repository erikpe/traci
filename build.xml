<project default="standalone-jar">
  
  <property name="version" value="0.0.1" />
  <property name="src" value="src" />
  <property name="bin" value="bin" />
  <property name="lib" value="lib" />
  <property name="tmp" value="tmp" />
  <property name="sisc" value="sisc-1.16.6" />
  <property name="antlr-dir" value="antlr-3.4" />
  <property name="antlr-jar" value="antlr-3.4-complete-no-antlrv2.jar" />
  <property name="jarfile" value="traci-${version}.jar" />
  <property name="src-distfile" value="traci-${version}.tar.gz" />
  
  <target name="clean">
    <delete file="${src}/traci/lang/parser/TraciLexer.java" />
    <delete file="${src}/traci/lang/parser/TraciParser.java" />
    <delete file="${src}/traci/lang/parser/TraciTreeWalker.java" />
    <delete file="${src}/traci/lang/parser/Traci.tokens" />
    <delete file="${src}/traci/lang/parser/TraciTreeWalker.tokens" />
    <delete dir="${bin}" />
    <delete dir="${tmp}" />
    <delete file="${jarfile}" />
    <delete file="${src-distfile}" />
  </target>

  <target name="antlr-generate-parser">
    <java jar="${lib}/${antlr-dir}/${antlr-jar}" fork="true">
      <arg value="-fo" />
      <arg value="${src}/traci/lang/parser" />
      <arg value="${src}/traci/lang/grammar/Traci.g" />
      <arg value="${src}/traci/lang/grammar/TraciTreeWalker.g" />
    </java>
  </target>
  
  <target name="compile" depends="generate-parser">
    <mkdir dir="${bin}" />
    <javac srcdir="${src}" destdir="${bin}" includeantruntime="false">
      <classpath>
        <pathelement location="${lib}/${antlr-dir}/${antlr-jar}" />
	<pathelement location="${lib}/${sisc}/sisc.jar" />
	<pathelement location="${lib}/${sisc}/sisc-opt.jar" />
      </classpath>
    </javac>
  </target>
  
  <target name="unpack-lib-jars">
    <mkdir dir="${tmp}/${antlr-dir}" />
    <unjar src="${lib}/${antlr-dir}/${antlr-jar}" dest="${tmp}/${antlr-dir}">
      <patternset>
        <exclude name="META-INF/" />
      </patternset>
    </unjar>
    <mkdir dir="${tmp}/${sisc}" />
    <unjar src="${lib}/${sisc}/sisc.jar" dest="${tmp}/${sisc}">
      <patternset>
	<exclude name="META-INF/" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${sisc}/sisc-opt.jar" dest="${tmp}/${sisc}">
      <patternset>
	<exclude name="META-INF/" />
      </patternset>
    </unjar>
  </target>
  
  <target name="standalone-jar" depends="compile, unpack-lib-jars">
    <jar destfile="${jarfile}">
      <fileset dir="${bin}" />
      <fileset dir="${src}" />
      <fileset dir="." includes="scheme/" />
      <fileset dir="." includes="images/" />
      <fileset dir="${tmp}/${sisc}" />
      <fileset dir="${tmp}/${antlr-dir}" />
      <manifest>
        <attribute name="Main-Class" value="traci.main.Airplane" />
      </manifest>
    </jar>
  </target>
  
  <target name="src-dist">
    <tar destfile="${src-distfile}" compression="gzip">
      <tarfileset dir="." prefix="traci-${version}"
		  includes="src/, images/, scheme/, lib/, build.xml, README, COPYING" />
    </tar>
  </target>
  
</project>
