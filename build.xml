<project default="jar">

  <property name="version" value="0.0.1" />
  <property name="src" value="src" />
  <property name="bin" value="bin" />
  <property name="lib" value="lib" />
  <property name="tmp" value="tmp" />
  <property name="test" value="test" />
  <property name="bin-test" value="bin-test" />
  <property name="test-output" value="test-output" />

  <property name="antlr-dir" value="antlr-3.5" />
  <property name="antlr-jar" value="antlr-3.5-complete-no-st3.jar" />
  <property name="antlr-runtime-jar" value="antlr-runtime-3.5.jar" />
  <property name="antlr-runtime-sources-jar" value="antlr-runtime-sources-3.5.jar" />
  <property name="commons-cli-dir" value="commons-cli-1.2" />
  <property name="commons-cli-jar" value="commons-cli-1.2.jar" />
  <property name="commons-cli-sources-jar" value="commons-cli-1.2-sources.jar" />
  <property name="anarres-cpp-dir" value="anarres-cpp-bin-1.2.8" />
  <property name="anarres-cpp-jar" value="anarres-cpp-bin-1.2.8.jar" />
  <property name="anarres-cpp-sources-jar" value="anarres-cpp-sources-1.2.8.jar" />
  <property name="junit-dir" value="junit-4.11" />
  <property name="junit-jar" value="junit-4.11.jar" />
  <property name="hamcrest-jar" value="hamcrest-core-1.3.jar" />

  <property name="jarfile" value="traci-${version}.jar" />
  <property name="src-distfile" value="traci-${version}.tar.gz" />

  <target name="clean">
    <delete file="${src}/se/ejp/traci/lang/parser/TraciLexer.java" />
    <delete file="${src}/se/ejp/traci/lang/parser/TraciParser.java" />
    <delete file="${src}/se/ejp/traci/lang/parser/TraciTreeWalker.java" />
    <delete file="${src}/se/ejp/traci/lang/parser/Traci.tokens" />
    <delete file="${src}/se/ejp/traci/lang/parser/TraciTreeWalker.tokens" />
    <delete dir="${bin}" />
    <delete dir="${bin-test}" />
    <delete dir="${tmp}" />
    <delete dir="${test-output}" />
    <delete file="${jarfile}" />
    <delete file="${src-distfile}" />
  </target>

  <target name="generate-parser">
    <java jar="${lib}/${antlr-dir}/${antlr-jar}" fork="true">
      <arg value="-fo" />
      <arg value="${src}/se/ejp/traci/lang/parser" />
      <arg value="${src}/se/ejp/traci/lang/grammar/Traci.g" />
      <arg value="${src}/se/ejp/traci/lang/grammar/TraciTreeWalker.g" />
    </java>
  </target>

  <target name="compile" depends="generate-parser">
    <mkdir dir="${bin}" />
    <javac srcdir="${src}" destdir="${bin}" includeantruntime="false">
      <classpath>
        <pathelement location="${lib}/${antlr-dir}/${antlr-runtime-jar}" />
        <pathelement location="${lib}/${commons-cli-dir}/${commons-cli-jar}" />
        <pathelement location="${lib}/${anarres-cpp-dir}/${anarres-cpp-jar}" />
      </classpath>
    </javac>
  </target>

  <target name="compile-test" depends="compile">
    <mkdir dir="${bin-test}" />
    <javac srcdir="${test}" destdir="${bin-test}" includeantruntime="false">
      <classpath>
        <pathelement location="${bin}" />
        <pathelement location="${lib}/${antlr-dir}/${antlr-runtime-jar}" />
        <pathelement location="${lib}/${commons-cli-dir}/${commons-cli-jar}" />
        <pathelement location="${lib}/${anarres-cpp-dir}/${anarres-cpp-jar}" />
        <pathelement location="${lib}/${junit-dir}/${junit-jar}" />
      </classpath>
    </javac>
  </target>

  <target name="unpack-libs">
    <delete dir="${tmp}" />
    <unjar src="${lib}/${antlr-dir}/${antlr-runtime-jar}" dest="${tmp}/${antlr-dir}">
      <patternset>
        <include name="org/antlr/runtime/**" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${antlr-dir}/${antlr-runtime-sources-jar}" dest="${tmp}/${antlr-dir}">
      <patternset>
        <include name="org/antlr/runtime/**" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${commons-cli-dir}/${commons-cli-jar}" dest="${tmp}/${commons-cli-dir}">
      <patternset>
        <include name="org/apache/commons/cli/**" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${commons-cli-dir}/${commons-cli-sources-jar}" dest="${tmp}/${commons-cli-dir}">
      <patternset>
        <include name="org/apache/commons/cli/**" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${anarres-cpp-dir}/${anarres-cpp-jar}" dest="${tmp}/${anarres-cpp-dir}">
      <patternset>
        <include name="org/anarres/**" />
      </patternset>
    </unjar>
    <unjar src="${lib}/${anarres-cpp-dir}/${anarres-cpp-sources-jar}" dest="${tmp}/${anarres-cpp-dir}">
      <patternset>
        <include name="org/anarres/**" />
      </patternset>
    </unjar>
  </target>

  <target name="jar" depends="compile, unpack-libs">
    <jar destfile="${jarfile}">
      <fileset dir="${bin}" />
      <fileset dir="${src}" />
      <fileset dir="${tmp}/${antlr-dir}" />
      <fileset dir="${tmp}/${commons-cli-dir}" />
      <fileset dir="${tmp}/${anarres-cpp-dir}" />
      <manifest>
        <attribute name="Main-Class" value="se.ejp.traci.main.Main" />
      </manifest>
    </jar>
  </target>

  <target name="src-dist">
    <tar destfile="${src-distfile}" compression="gzip">
      <tarfileset dir="." prefix="traci-${version}">
        <include name="src/" />
        <include name="test/" />
        <include name="scenes/" />
        <include name="images/" />
        <include name="lib/" />
        <include name="build.xml" />
        <include name="README" />
        <include name="COPYING" />
      </tarfileset>
    </tar>
  </target>

  <target name="test" depends="compile, compile-test">
    <mkdir dir="${test-output}" />
    <junit printsummary="yes" haltonfailure="yes" showoutput="yes">
      <classpath>
        <pathelement location="${bin}" />
        <pathelement location="${bin-test}" />
        <pathelement location="${lib}/${antlr-dir}/${antlr-runtime-jar}" />
        <pathelement location="${lib}/${commons-cli-dir}/${commons-cli-jar}" />
        <pathelement location="${lib}/${anarres-cpp-dir}/${anarres-cpp-jar}" />
        <pathelement location="${lib}/${junit-dir}/${hamcrest-jar}" />
        <pathelement location="${lib}/${junit-dir}/${junit-jar}" />
      </classpath>
      <formatter type="xml" />
      <batchtest todir="${test-output}">
        <fileset dir="${test}" includes="**/Test*.java" />
      </batchtest>
    </junit>
  </target>

  <target name="test-report" depends="test">
    <junitreport todir="${test-output}">
      <fileset dir="${test-output}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${test-output}" />
    </junitreport>
  </target>

</project>
